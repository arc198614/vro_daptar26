{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="fw-bold text-dark mb-4">अनुपालन अहवाल (Compliance Report)</h2>

        <div class="card p-4">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>तपासणी ID</th>
                            <th>अधिकारी शेरा</th>
                            <th>वरिष्ठ मत</th>
                            <th>स्पष्टीकरण (GMA)</th>
                            <th>स्थिती</th>
                            <th>कृती</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if compliance_data %}
                        {% for item in compliance_data %}
                        <tr>
                            <td><small class="text-muted">#{{ item['Log_ID'] }}</small></td>
                            <td>{{ item['अधिकारी शेरा'] }}</td>
                            <td>{{ item['वरिष्ठ मत'] or '-' }}</td>
                            <td>
                                {% if item['स्पष्टीकरण'] %}
                                {{ item['स्पष्टीकरण'] }}
                                {% else %}
                                <span class="text-secondary italic small">प्रलंबित (Pending)</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item['स्थिती'] == 'Pending' %}
                                <span class="badge bg-warning text-dark">प्रलंबित</span>
                                {% elif item['स्थिती'] == 'पूर्तता मान्य' %}
                                <span class="badge bg-success">पूर्तता मान्य</span>
                                {% else %}
                                <span class="badge bg-danger">{{ item['स्थिती'] }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                    data-bs-target="#updateModal" data-logid="{{ item['Log_ID'] }}"
                                    data-remark="{{ item['अधिकारी शेरा'] }}" data-senior="{{ item['वरिष्ठ मत'] }}"
                                    data-explanation="{{ item['स्पष्टीकरण'] }}" data-status="{{ item['स्थिती'] }}">
                                    अपडेट
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-secondary">कोणताही अनुपालन अहवाल सापडला नाही.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">अनुपालन स्थिती अपडेट करा</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('compliance') }}" method="POST">
                <div class="modal-body">
                    <input type="hidden" name="log_id" id="modal_log_id">
                    <input type="hidden" name="remark" id="modal_remark">

                    <div class="mb-3">
                        <label class="form-label text-secondary">अधिकारी शेरा</label>
                        <p id="display_remark" class="fw-bold"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">स्पष्टीकरण (GMA Explanation)</label>
                        <textarea class="form-control" name="explanation" id="modal_explanation" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">वरिष्ठ मत (Senior Feedback)</label>
                        <textarea class="form-control" name="senior_remark" id="modal_senior" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">स्थिती (Status)</label>
                        <select class="form-control" name="status" id="modal_status">
                            <option value="Pending">Pending (प्रलंबित)</option>
                            <option value="पूर्तता मान्य">पूर्तता मान्य (Approved)</option>
                            <option value="अमान्य">अमान्य (Rejected)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द करा</button>
                    <button type="submit" class="btn btn-primary">जतन करा (Save Changes)</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var updateModal = document.getElementById('updateModal');
        updateModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;

            var logId = button.getAttribute('data-logid');
            var remark = button.getAttribute('data-remark');
            var senior = button.getAttribute('data-senior');
            var explanation = button.getAttribute('data-explanation');
            var status = button.getAttribute('data-status');

            document.getElementById('modal_log_id').value = logId;
            document.getElementById('modal_remark').value = remark;
            document.getElementById('display_remark').textContent = remark;
            document.getElementById('modal_senior').value = senior;
            document.getElementById('modal_explanation').value = explanation;
            document.getElementById('modal_status').value = status;
        });
    });
</script>
{% endblock %}